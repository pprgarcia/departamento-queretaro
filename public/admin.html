<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Leads</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <h1 class="text-3xl font-bold text-indigo-800 mb-6 text-center">Panel Admin - Leads</h1>
    
    <!-- Login -->
    <div id="login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
      <input type="password" id="pass" placeholder="Contrase√±a" class="w-full p-3 border rounded-lg mb-4">
      <button onclick="login()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold">Entrar</button>
    </div>

    <!-- Panel -->
    <div id="panel" class="hidden mt-8">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
          <h2 class="text-2xl font-bold text-gray-800">Leads recibidos</h2>
          <div class="flex gap-3">
            <button onclick="exportarExcel()" class="bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700">
              üìä Exportar Excel
            </button>
            <button onclick="borrarSeleccionados()" class="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700">
              üóëÔ∏è Borrar seleccionados
            </button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full table-auto" id="tabla">
            <thead class="bg-indigo-600 text-white">
              <tr>
                <th class="px-4 py-3"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                <th class="px-4 py-3">Contactado</th>
                <th class="px-4 py-3">Nombre</th>
                <th class="px-4 py-3">Tel√©fono</th>
                <th class="px-4 py-3">Email</th>
                <th class="px-4 py-3">Comentario</th>
                <th class="px-4 py-3">Horario</th>
                <th class="px-4 py-3">Fecha</th>
              </tr>
            </thead>
            <tbody class="text-gray-700"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const contrase√±a = "MiDeptoSecure2025!"; 
      const SUPABASE_URL="https://asezwpitjpsoimvfuwse.supabase.co";
      const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzZXp3cGl0anBzb2ltdmZ1d3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTg2MjIsImV4cCI6MjA3ODc5NDYyMn0.uQ_7fUy_cswe_OzmK1k_--BIO_55Bmy_6McqtgGK0SI";  // ‚Üê TU KEY

    function login() {
      if (document.getElementById('pass').value === contrase√±a) {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('panel').classList.remove('hidden');
        cargarLeads();
      } else alert("Contrase√±a incorrecta");
    }

    async function cargarLeads() {
      try {
        const res = await axios.get(`${SUPABASE_URL}/rest/v1/leads?select=*&order=fecha_envio.desc`, {
          headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }
        });

        const tbody = document.querySelector('#tabla tbody');
        tbody.innerHTML = '';

        if (res.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No hay leads a√∫n</td></tr>';
          return;
        }

        res.data.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'border-b hover:bg-gray-50';
          tr.innerHTML = `
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="delete-check" data-id="${row.id}">
            </td>
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="contactado-check" data-id="${row.id}" ${row.contactado ? 'checked' : ''} onchange="marcarContactado(${row.id}, this.checked)">
            </td>
            <td class="px-4 py-3 font-medium">${row.nombre || '-'}</td>
            <td class="px-4 py-3">${row.telefono || '-'}</td>
            <td class="px-4 py-3">${row.email || '-'}</td>
            <td class="px-4 py-3 max-w-xs truncate">${row.comentario || '-'}</td>
            <td class="px-4 py-3">${row.horario_preferido || '-'}</td>
            <td class="px-4 py-3 text-sm">${new Date(row.fecha_envio).toLocaleString('es-MX')}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) { console.error(e); alert("Error al cargar leads"); }
    }

    // Marcar como contactado
    async function marcarContactado(id, checked) {
      await fetch(`${SUPABASE_URL}/rest/v1/leads?id=eq.${id}`, {
        method: 'PATCH',
        headers: {
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ contactado: checked })
      });
    }

    // Borrar seleccionados
    async function borrarSeleccionados() {
      const checks = document.querySelectorAll('.delete-check:checked');
      if (checks.length === 0) return alert("Selecciona al menos un lead para borrar");

      if (!confirm(`¬øBorrar ${checks.length} lead(s) seleccionados?`)) return;

      for (const check of checks) {
        const id = check.dataset.id;
        await fetch(`${SUPABASE_URL}/rest/v1/leads?id=eq.${id}`, {
          method: 'DELETE',
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            'Prefer': 'return=minimal'
          }
        });
      }
      alert("¬°Leads borrados!");
      cargarLeads();
    }

    // Seleccionar todos
    function toggleSelectAll() {
      const master = document.getElementById('selectAll');
      document.querySelectorAll('.delete-check').forEach(cb => cb.checked = master.checked);
    }

    function exportarExcel() {
      const tabla = document.getElementById('tabla');
      const wb = XLSX.utils.table_to_book(tabla, { sheet: "Leads" });
      const fecha = new Date().toISOString().slice(0,10);
      XLSX.writeFile(wb, `leads_departamento_${fecha}.xlsx`);
    }

    // Enter para login
    document.getElementById('pass')?.addEventListener('keypress', e => { if (e.key === 'Enter') login(); });
  </script>
</body>
</html>

